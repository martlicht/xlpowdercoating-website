---
import { Image } from "astro:assets";
import backgroundImage from "../assets/images/background5.webp";
---

<section
  class="relative py-20 px-4 md:px-8 lg:px-16 font-sans overflow-hidden"
  id="contact"
>
  <!-- Background Image -->
  <div class="absolute inset-0 z-0" aria-hidden="true">
    <Image
      src={backgroundImage}
      alt="XL Industrial Powder Coating contact background"
      format="webp"
      quality={80}
      class="w-full h-full object-cover"
      loading="lazy"
    />
    <div class="absolute inset-0 bg-black/90 z-10"></div>
  </div>

  <!-- Content Container -->
  <div
    class="relative z-20 w-full px-8 md:px-12 lg:px-16 xl:px-24 py-12 md:py-16"
  >
    <div class="flex flex-col lg:flex-row gap-12 lg:gap-16 max-w-7xl mx-auto">
      <!-- Left Column - Contact Information -->
      <div class="flex-1 flex flex-col" data-aos="fade-right" data-aos-duration="500">
        <p
          class="text-sm md:text-base uppercase tracking-wider text-white/80 mb-2 font-sans"
        >
          Contact
        </p>
        <h2
          class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold uppercase italic text-white mb-4 md:mb-6 font-sans"
        >
          GET IN TOUCH
        </h2>
        <p 
          class="text-base md:text-lg text-white/90 mb-8 md:mb-12 font-sans"
        >
          Tell us about your project and we'll provide a quote.
        </p>

        <!-- Contact Details -->
        <div class="flex flex-col gap-6 md:gap-8">
          <!-- Email -->
          <div 
            class="flex items-start gap-4"
          >
            <div class="mt-1">
              <svg
                class="w-5 h-5 text-white/80"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                ></path>
              </svg>
            </div>
            <a
              href="mailto:info@xlpowdercoating.com"
              class="text-base md:text-lg text-white hover:text-white/80 transition-colors font-sans"
            >
              info@xlpowdercoating.com
            </a>
          </div>

          <!-- Phone -->
          <div 
            class="flex items-start gap-4"
          >
            <div class="mt-1">
              <svg
                class="w-5 h-5 text-white/80"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                ></path>
              </svg>
            </div>
            <a
              href="tel:8453675020"
              class="text-base md:text-lg text-white hover:text-white/80 transition-colors font-sans"
            >
              845-367-5020
            </a>
          </div>

          <!-- Address -->
          <div 
            class="flex items-start gap-4"
          >
            <div class="mt-1">
              <svg
                class="w-5 h-5 text-white/80"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <p class="text-base md:text-lg text-white font-sans">
              100 Sterling Mine Rd, Sloatsburg, NY 10974
            </p>
          </div>
        </div>
      </div>

      <!-- Right Column - Contact Form -->
      <div class="flex-1">
        <!-- Success/Error Messages -->
        <div id="form-message" class="hidden mb-4 p-4 rounded-lg font-sans"></div>
        
        <form id="contact-form" class="flex flex-col gap-6 md:gap-8" method="POST">
          <!-- Name Fields -->
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1 flex flex-col gap-2">
              <label for="firstName" class="text-white font-sans">First name</label>
              <input
                type="text"
                id="firstName"
                name="firstName"
                required
                class="w-full bg-transparent border border-[#DC2626] rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[#DC2626] font-sans"
                style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);"
              />
            </div>
            <div class="flex-1 flex flex-col gap-2">
              <label for="lastName" class="text-white font-sans">Last name</label>
              <input
                type="text"
                id="lastName"
                name="lastName"
                required
                class="w-full bg-transparent border border-[#DC2626] rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[#DC2626] font-sans"
                style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);"
              />
            </div>
          </div>

          <!-- Email and Phone -->
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1 flex flex-col gap-2">
              <label for="email" class="text-white font-sans">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full bg-transparent border border-[#DC2626] rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[#DC2626] font-sans"
                style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);"
              />
            </div>
            <div class="flex-1 flex flex-col gap-2">
              <label for="phone" class="text-white font-sans">Phone number</label>
              <input
                type="tel"
                id="phone"
                name="phone"
                required
                class="w-full bg-transparent border border-[#DC2626] rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[#DC2626] font-sans"
                style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);"
              />
            </div>
          </div>

          <!-- Project Dropdown -->
          <div class="flex flex-col gap-2">
            <label for="project" class="text-white font-sans">What's your project?</label>
            <select
              id="project"
              name="project"
              required
              class="w-full bg-transparent border border-[#DC2626] rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[#DC2626] font-sans"
              style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);"
            >
              <option value="">Select one...</option>
              <option value="small">Small project</option>
              <option value="medium">Medium project</option>
              <option value="large">Large project</option>
              <option value="custom">Custom project</option>
            </select>
          </div>

          <!-- Service Radio Buttons -->
          <div class="flex flex-col gap-2">
            <p class="text-white font-sans">
              What service are you interested in?
            </p>
            <div class="flex flex-col sm:flex-row gap-6">
              <!-- Left Column -->
              <div class="flex-1 flex flex-col gap-3">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="radio"
                    name="service"
                    value="powder-coating"
                    required
                    class="w-5 h-5 border-2 border-[#DC2626] text-[#DC2626] focus:ring-2 focus:ring-[#DC2626] bg-transparent"
                  />
                  <span class="text-white font-sans">Powder coating</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="radio"
                    name="service"
                    value="touch-ups"
                    required
                    class="w-5 h-5 border-2 border-[#DC2626] text-[#DC2626] focus:ring-2 focus:ring-[#DC2626] bg-transparent"
                  />
                  <span class="text-white font-sans">Touch ups & Recoating</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="radio"
                    name="service"
                    value="color-matching"
                    required
                    class="w-5 h-5 border-2 border-[#DC2626] text-[#DC2626] focus:ring-2 focus:ring-[#DC2626] bg-transparent"
                  />
                  <span class="text-white font-sans">Custom Color Matching</span>
                </label>
              </div>
              <!-- Right Column -->
              <div class="flex-1 flex flex-col gap-3">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="radio"
                    name="service"
                    value="sandblasting"
                    required
                    class="w-5 h-5 border-2 border-[#DC2626] text-[#DC2626] focus:ring-2 focus:ring-[#DC2626] bg-transparent"
                  />
                  <span class="text-white font-sans">Sandblasting</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="radio"
                    name="service"
                    value="other"
                    required
                    class="w-5 h-5 border-2 border-[#DC2626] text-[#DC2626] focus:ring-2 focus:ring-[#DC2626] bg-transparent"
                  />
                  <span class="text-white font-sans">Other</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Message Textarea -->
          <div class="flex flex-col gap-2">
            <label for="message" class="text-white font-sans">Message</label>
            <textarea
              id="message"
              name="message"
              rows="5"
              placeholder="Tell us more..."
              required
              class="w-full bg-transparent border border-[#DC2626] rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#DC2626] resize-none font-sans"
              style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);"
            ></textarea>
          </div>

          <!-- Checkbox -->
          <!-- <div>
            <label class="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                name="terms"
                required
                class="w-5 h-5 border-2 border-[#DC2626] text-[#DC2626] focus:ring-2 focus:ring-[#DC2626] bg-transparent rounded"
              />
              <span class="text-white font-sans">I agree to the terms</span>
            </label>
          </div> -->

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-[#DC2626] hover:bg-[#B91C1C] text-white px-8 py-4 rounded-lg font-semibold transition-colors font-sans text-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="submit-text">Submit</span>
            <span id="submit-loading" class="hidden">Sending...</span>
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const submitLoading = document.getElementById('submit-loading') as HTMLSpanElement;
  const formMessage = document.getElementById('form-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Reset message
    formMessage.classList.add('hidden');
    formMessage.textContent = '';
    
    // Disable submit button
    submitBtn.disabled = true;
    submitText.classList.add('hidden');
    submitLoading.classList.remove('hidden');
    
    try {
      // Get form data
      const formData = new FormData(form);
      const data = {
        firstName: formData.get('firstName') as string,
        lastName: formData.get('lastName') as string,
        email: formData.get('email') as string,
        phone: formData.get('phone') as string,
        project: formData.get('project') as string,
        service: formData.get('service') as string,
        message: formData.get('message') as string
      };
      
      // Obtener variables de entorno (públicas para cliente)
      const API_URL = import.meta.env.PUBLIC_API_URL || '';
      const API_KEY = import.meta.env.PUBLIC_API_KEY || '';
      
      if (!API_URL || !API_KEY) {
        throw new Error('API configuration missing');
      }
      
      // Mapear los valores del servicio
      const serviceMap: Record<string, string> = {
        'powder-coating': 'Powder coating',
        'touch-ups': 'Touch ups & Recoating',
        'color-matching': 'Custom Color Matching',
        'sandblasting': 'Sandblasting',
        'other': 'Other'
      };
      
      // Extraer código de país del teléfono (por defecto US si no se detecta)
      const phoneNumber = data.phone?.replace(/\D/g, '') || '';
      let phoneCountryCode = 'US'; // Por defecto US
      
      // Detectar código de país básico
      if (phoneNumber.startsWith('1') && phoneNumber.length === 11) {
        phoneCountryCode = 'US';
      } else if (phoneNumber.startsWith('809') || phoneNumber.startsWith('829') || phoneNumber.startsWith('849')) {
        phoneCountryCode = 'DO';
      }
      
      // Asegurar que la URL tenga protocolo
      let apiUrl = API_URL;
      if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        apiUrl = `https://${apiUrl}`;
      }
      
      // Remover trailing slash si existe
      apiUrl = apiUrl.replace(/\/$/, '');
      
      // Construir el payload
      const payload = {
        first_name: data.firstName || '',
        last_name: data.lastName || '',
        email: data.email || '',
        phone_number: phoneNumber,
        phone_country_code: phoneCountryCode,
        message: data.message || '',
        source: 'XL',
        intrested: serviceMap[data.service] || data.service || '',
        project: data.project || ''
      };
      
      // Send to external API
      const response = await fetch(`${apiUrl}/contacts/leads/create/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'HTTP_APIkey': API_KEY
        },
        body: JSON.stringify(payload)
      });
      
      let result;
      const responseContentType = response.headers.get('content-type');
      
      if (responseContentType && responseContentType.includes('application/json')) {
        result = await response.json();
      } else {
        result = await response.text();
      }
      
      if (response.ok) {
        // Success
        formMessage.classList.remove('hidden');
        formMessage.classList.add('bg-green-500/20', 'border', 'border-green-500', 'text-green-400');
        formMessage.textContent = 'Thank you! Your message has been sent successfully.';
        form.reset();
      } else {
        // Error
        formMessage.classList.remove('hidden');
        formMessage.classList.add('bg-red-500/20', 'border', 'border-red-500', 'text-red-400');
        const errorMessage = typeof result === 'object' && result.error 
          ? result.error 
          : typeof result === 'string' 
            ? result 
            : 'Failed to send message. Please try again.';
        formMessage.textContent = errorMessage;
      }
    } catch (error) {
      // Network or other error
      formMessage.classList.remove('hidden');
      formMessage.classList.add('bg-red-500/20', 'border', 'border-red-500', 'text-red-400');
      formMessage.textContent = 'An error occurred. Please try again later.';
      console.error('Form submission error:', error);
    } finally {
      // Re-enable submit button
      submitBtn.disabled = false;
      submitText.classList.remove('hidden');
      submitLoading.classList.add('hidden');
    }
  });
</script>

<style>
  /* Estilos para los inputs de radio y checkbox */
  input[type="radio"],
  input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: transparent;
    touch-action: manipulation;
    -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);
  }

  input[type="radio"] {
    border-radius: 50%;
  }

  input[type="radio"]:checked {
    background-color: #dc2626;
    border-color: #dc2626;
  }

  input[type="checkbox"]:checked {
    background-color: #dc2626;
    border-color: #dc2626;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
    background-size: 16px;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* Estilos para el select */
  select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23DC2626'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    padding-right: 40px;
    touch-action: manipulation;
    -webkit-tap-highlight-color: rgba(220, 38, 38, 0.3);
  }

  select option {
    background-color: rgba(30, 30, 30, 0.95);
    color: white;
  }
</style>
